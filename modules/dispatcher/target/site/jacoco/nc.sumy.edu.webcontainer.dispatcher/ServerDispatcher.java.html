<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="ru"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>ServerDispatcher.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">dispatcher</a> &gt; <a href="index.source.html" class="el_package">nc.sumy.edu.webcontainer.dispatcher</a> &gt; <span class="el_source">ServerDispatcher.java</span></div><h1>ServerDispatcher.java</h1><pre class="source lang-java linenums">package nc.sumy.edu.webcontainer.dispatcher;

import nc.sumy.edu.webcontainer.cgi.CgiHandlerImpl;
import nc.sumy.edu.webcontainer.common.FileNotReadException;
import nc.sumy.edu.webcontainer.configuration.ServerConfiguration;
import nc.sumy.edu.webcontainer.deployment.Deployment;
import nc.sumy.edu.webcontainer.http.*;
import nc.sumy.edu.webcontainer.sequrity.Security;
import nc.sumy.edu.webcontainer.sequrity.ServerSecurity;
import nc.sumy.edu.webcontainer.web.*;
import org.apache.commons.lang3.StringUtils;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import java.io.File;
import java.text.DateFormat;
import java.util.Date;
import java.util.Map;
import java.util.TimeZone;
import java.util.concurrent.ConcurrentHashMap;

import static nc.sumy.edu.webcontainer.dispatcher.Header.*;
import static nc.sumy.edu.webcontainer.dispatcher.PageType.*;
import static nc.sumy.edu.webcontainer.http.HttpResponse.getResponseCode;
import static nc.sumy.edu.webcontainer.http.ResponseCode.*;
import static org.apache.commons.lang3.StringUtils.*;

/**
 * Class that takes a request, analyzes it and gives the output response.
 * @author Vinogradov M.O.
 */
@SuppressWarnings(&quot;PMD&quot;)
public class ServerDispatcher implements Dispatcher{
<span class="fc" id="L34">    private static final Logger LOG = LoggerFactory.getLogger(ServerDispatcher.class);</span>
    private String errorPagesPath;
    private final ServerConfiguration serverConfiguration;
    private final Deployment deployment;
    private Security security;
    private Request request;
    private HttpResponse response;

<span class="fc" id="L42">    public ServerDispatcher(ServerConfiguration serverConfiguration, Deployment deployment) {</span>
<span class="fc" id="L43">        this.deployment = deployment;</span>
<span class="fc" id="L44">        this.serverConfiguration = serverConfiguration;</span>
<span class="fc" id="L45">    }</span>

    @Override
    public HttpResponse getResponse(Request request) {
<span class="fc" id="L49">        this.request = request;</span>
<span class="fc" id="L50">        security = new ServerSecurity(request, serverConfiguration);</span>
<span class="fc" id="L51">        errorPagesPath  = serverConfiguration.getServerLocation() + File.separator +</span>
                &quot;www&quot; + File.separator + &quot;default&quot; + File.separator;
<span class="fc" id="L53">        makeResponse();</span>
<span class="fc" id="L54">        return response;</span>
    }

    private void makeResponse() {
<span class="fc" id="L58">        String pagePath = serverConfiguration.getServerLocation() + File.separator + &quot;www&quot; + File.separator</span>
<span class="fc" id="L59">                + request.getUrn().replace(&quot;/&quot;,File.separator);</span>
<span class="fc bfc" id="L60" title="All 2 branches covered.">        if (initialInspection())</span>
<span class="fc" id="L61">            return;</span>
<span class="pc bpc" id="L62" title="1 of 2 branches missed.">        if (!security.isAllow()) {</span>
<span class="nc" id="L63">            createErrorPageResponse(FORBIDDEN);</span>
<span class="nc" id="L64">            return;</span>
        }
<span class="fc bfc" id="L66" title="All 2 branches covered.">        if (createIndexPage(pagePath))</span>
<span class="fc" id="L67">            return;</span>
<span class="pc bpc" id="L68" title="1 of 2 branches missed.">        if (createCgiPage(pagePath))</span>
<span class="nc" id="L69">            return;</span>
<span class="fc bfc" id="L70" title="All 2 branches covered.">        if (createStaticOrJspPage(pagePath)) {</span>
<span class="fc" id="L71">            makeRedirection();</span>
<span class="fc" id="L72">            return;</span>
        }
<span class="fc bfc" id="L74" title="All 2 branches covered.">        if (createServletPage()) {</span>
<span class="fc" id="L75">            makeRedirection();</span>
<span class="fc" id="L76">            return;</span>
        }
<span class="fc" id="L78">        createErrorPageResponse(NOT_FOUND);</span>
<span class="fc" id="L79">    }</span>

    private boolean initialInspection() {
<span class="fc bfc" id="L82" title="All 2 branches covered.">        if (request.getMethod() == HttpMethod.OPTIONS) {</span>
<span class="fc" id="L83">            response = new HttpResponse(OK.getCode());</span>
<span class="fc" id="L84">            setErrorPageHeaders(response);</span>
<span class="fc" id="L85">            response.setBody(&quot;200 OK&quot;.getBytes());</span>
<span class="fc" id="L86">            return true;</span>
<span class="pc bpc" id="L87" title="1 of 2 branches missed.">        } else if (request.getMethod() == HttpMethod.UNKNOWN) {</span>
<span class="nc" id="L88">            createErrorPageResponse(NOT_ALLOWED);</span>
<span class="nc" id="L89">            return true;</span>
        }
<span class="fc" id="L91">        return false;</span>
    }

    private void makeRedirection() {
<span class="fc" id="L95">        response.setHeader(&quot;Content-Length&quot;, Integer.toString(response.getBody().length));</span>
<span class="fc bfc" id="L96" title="All 2 branches covered.">        if (isNotEmpty(response.getRedirectUrl())) {</span>
<span class="fc" id="L97">            request.setUrn(response.getRedirectUrl());</span>
<span class="fc" id="L98">            makeResponse();</span>
        }
<span class="fc" id="L100">    }</span>

    private boolean createIndexPage(String pagePath) {
<span class="fc" id="L103">        File page = new File(pagePath);</span>
<span class="fc bfc" id="L104" title="All 4 branches covered.">        if (page.exists() &amp;&amp; page.isDirectory()) {</span>
<span class="pc bpc" id="L105" title="1 of 2 branches missed.">            if(!endsWith(pagePath.replace(&quot;\\&quot;, &quot;/&quot;), &quot;/&quot;)) {</span>
<span class="nc" id="L106">                createRedirectPage();</span>
<span class="nc" id="L107">                return true;</span>
            }
<span class="fc" id="L109">            String index = &quot;index.&quot;;</span>
<span class="fc" id="L110">            File indexPage = new File(pagePath + File.separator + index + HTML.getFileExtension());</span>
<span class="fc bfc" id="L111" title="All 2 branches covered.">            if (indexPage.exists()) {</span>
<span class="fc" id="L112">                createStaticPageResponse(indexPage);</span>
<span class="fc" id="L113">                return true;</span>
            }
<span class="fc" id="L115">            indexPage = new File(pagePath + File.separator + index + JSP.getFileExtension());</span>
<span class="pc bpc" id="L116" title="1 of 2 branches missed.">            if (indexPage.exists()) {</span>
<span class="nc" id="L117">                createJspPageResponse(indexPage);</span>
<span class="nc" id="L118">                return true;</span>
            }
<span class="fc" id="L120">            createFileListPageResponse(page.listFiles());</span>
<span class="fc" id="L121">            return true;</span>
        }
<span class="fc" id="L123">        return false;</span>
    }

    private void createRedirectPage() {
<span class="nc" id="L127">        response = new HttpResponse(OK.getCode());</span>
<span class="nc" id="L128">        response.setHeader(&quot;Refresh&quot;, &quot;0;url=&quot; + request.getUrn() + &quot;/&quot;);</span>
<span class="nc" id="L129">        response.setBody(new byte[0]);</span>
<span class="nc" id="L130">    }</span>

    private boolean createStaticOrJspPage(String pagePath) {
<span class="fc" id="L133">        File page = new File(pagePath);</span>
<span class="fc bfc" id="L134" title="All 2 branches covered.">        if (page.exists()) {</span>
<span class="fc bfc" id="L135" title="All 2 branches covered.">            if (endsWith(pagePath, &quot;.&quot; +  JSP.getFileExtension())) {</span>
<span class="fc" id="L136">                createJspPageResponse(page);</span>
<span class="fc" id="L137">                return true;</span>
            } else {
<span class="fc" id="L139">                createStaticPageResponse(page);</span>
<span class="fc" id="L140">                return true;</span>
            }
        }
<span class="fc" id="L143">        return false;</span>
    }

    private boolean createCgiPage(String pagePath) {
<span class="fc" id="L147">        File page = new File(pagePath);</span>
<span class="pc bpc" id="L148" title="1 of 4 branches missed.">        if (page.exists() &amp;&amp; endsWith(pagePath, &quot;.&quot; +  CGI.getFileExtension())) {</span>
<span class="nc" id="L149">            createCgiPageResponse(request.getParameters());</span>
<span class="nc" id="L150">            return true;</span>
        }
<span class="fc" id="L152">        return false;</span>
    }

    private void createCgiPageResponse(Map&lt;String, String&gt; parameters) {
<span class="nc" id="L156">        response = new HttpResponse(OK.getCode());</span>
<span class="nc" id="L157">        String[] classNameArr = split(request.getUrn(), &quot;/&quot;);</span>
<span class="nc" id="L158">        String classNameWithExtension = classNameArr[classNameArr.length-1];</span>
<span class="nc" id="L159">        String className = split(classNameWithExtension, &quot;.&quot;)[0];</span>
<span class="nc" id="L160">        CgiHandlerImpl cgi= new CgiHandlerImpl();</span>
<span class="nc" id="L161">        String responseBody = cgi.process(className, parameters);</span>
<span class="nc" id="L162">        response.setBody(responseBody.getBytes());</span>
<span class="nc" id="L163">    }</span>

    private boolean createServletPage() {
<span class="fc" id="L166">        ConcurrentHashMap&lt;File, ConcurrentHashMap&lt;String, Class&gt;&gt; domainData = deployment.getDomainsData();</span>
<span class="fc bfc" id="L167" title="All 2 branches covered.">        for (Map.Entry&lt;File, ConcurrentHashMap&lt;String, Class&gt;&gt; domain : domainData.entrySet()) {</span>
<span class="fc bfc" id="L168" title="All 2 branches covered.">            if (findUrlMapping(request, domain)) {</span>
<span class="fc" id="L169">                return true;</span>
            }
<span class="fc" id="L171">        }</span>
<span class="fc" id="L172">        return false;</span>
    }

    @SuppressWarnings(&quot;PMD&quot;)
    private boolean findUrlMapping(Request request, Map.Entry&lt;File, ConcurrentHashMap&lt;String, Class&gt;&gt; domain) {
<span class="fc" id="L177">        String domainName = substring(domain.getKey().getPath(),</span>
<span class="fc" id="L178">                lastIndexOf(domain.getKey().getPath(), File.separator)).replace(File.separatorChar, '/');</span>
<span class="fc bfc" id="L179" title="All 2 branches covered.">        if (StringUtils.equals(request.getDomainName(), domainName)) {</span>
<span class="pc bpc" id="L180" title="1 of 2 branches missed.">            for (Map.Entry&lt;String, Class&gt; servletPair : domain.getValue().entrySet()) {</span>
<span class="pc bpc" id="L181" title="1 of 2 branches missed.">                if (endsWith(request.getUrn(), servletPair.getKey())) {</span>
<span class="fc" id="L182">                    ServletHandler handler = new ServletHandlerImpl();</span>
<span class="fc" id="L183">                    response = handler.processServlet((HttpRequest) request, servletPair.getValue());</span>
<span class="fc" id="L184">                    setSuccessHeaders(response);</span>
<span class="fc" id="L185">                    return true;</span>
                }
<span class="nc" id="L187">            }</span>
        }
<span class="fc" id="L189">        return false;</span>
    }

    private void createJspPageResponse(File page) {
<span class="fc" id="L193">        JspHandler handler = new JspHandlerImpl();</span>
<span class="fc" id="L194">        response = handler.processJSP((HttpRequest) request, page);</span>
<span class="fc" id="L195">    }</span>

    private void createStaticPageResponse(File page) {
<span class="fc" id="L198">        response = new HttpResponse(OK.getCode());</span>
<span class="fc" id="L199">        StaticContentHandler handler = new StaticContentHandlerImpl();</span>
<span class="fc" id="L200">        response.setBody(handler.process(page));</span>
<span class="fc" id="L201">        setSuccessHeaders(response);</span>
<span class="fc" id="L202">    }</span>

    private void createFileListPageResponse(File[] filesList) {
<span class="fc" id="L205">        response = new HttpResponse(OK.getCode());</span>
<span class="fc" id="L206">        StaticContentHandler handler = new StaticContentHandlerImpl();</span>
<span class="fc" id="L207">        byte[] top = handler.process(new File(errorPagesPath + &quot;filesListTop.html&quot;));</span>
<span class="fc" id="L208">        byte[] bottom = handler.process(new File(errorPagesPath + &quot;filesListBottom.html&quot;));</span>
<span class="fc" id="L209">        StringBuilder buider = new StringBuilder();</span>
<span class="fc" id="L210">        buider.append(&quot;&lt;ul&gt;&quot;);</span>
<span class="fc bfc" id="L211" title="All 2 branches covered.">        for (File f: filesList) {</span>
<span class="fc" id="L212">            buider.append(&quot;&lt;li class=\&quot;files-list-item\&quot;&gt;&quot;);</span>
<span class="fc bfc" id="L213" title="All 2 branches covered.">            if(f.isDirectory()) {</span>
<span class="fc" id="L214">                buider.append(&quot;Folder - &quot;);</span>
            }
            else{
<span class="fc" id="L217">                buider.append(&quot;File - &quot;);</span>
            }
<span class="fc" id="L219">            buider.append(f.getName());</span>
<span class="fc" id="L220">            buider.append(&quot;&lt;/li&gt;&quot;);</span>
        }
<span class="fc" id="L222">        buider.append(&quot;&lt;/ul&gt;&quot;);</span>
<span class="fc" id="L223">        byte[] middle = new String(buider).getBytes();</span>
<span class="fc" id="L224">        byte[] body = new byte[top.length + middle.length + bottom.length];</span>
<span class="fc" id="L225">        System.arraycopy(top, 0, body, 0, top.length);</span>
<span class="fc" id="L226">        System.arraycopy(middle, 0, body, top.length, middle.length);</span>
<span class="fc" id="L227">        System.arraycopy(bottom, 0, body, top.length + middle.length, bottom.length);</span>

<span class="fc" id="L229">        response.setBody(body);</span>
<span class="fc" id="L230">        setSuccessHeaders(response);</span>
<span class="fc" id="L231">    }</span>

    protected void createErrorPageResponse(ResponseCode code) {
<span class="fc" id="L234">        String errorPageTitle = code.getString() + &quot;.html&quot;;</span>
<span class="fc" id="L235">        response = new HttpResponse(code.getCode());</span>
<span class="fc" id="L236">        setErrorPageHeaders(response);</span>
<span class="fc" id="L237">        File errorPage = new File(errorPagesPath + errorPageTitle);</span>
<span class="fc" id="L238">        StaticContentHandler handler = new StaticContentHandlerImpl();</span>
        try {
<span class="fc" id="L240">            response.setBody(handler.process(errorPage));</span>
<span class="nc" id="L241">        } catch (FileNotReadException | StaticContentFileException e) {</span>
<span class="nc" id="L242">            response.setBody(getResponseCode(code.getCode()).getBytes());</span>
<span class="nc" id="L243">            LOG.warn(&quot;Cannot find or read default page &quot; + errorPageTitle, e);</span>
<span class="fc" id="L244">        }</span>
<span class="fc" id="L245">    }</span>

    private void setErrorPageHeaders(HttpResponse response){
<span class="fc" id="L248">        setDefaultHeaders(response);</span>
<span class="fc" id="L249">        setContentType(response, HTML.getMIME());</span>
<span class="fc" id="L250">        response.setHeader(CONTENT_LANGUAGE.getHeader(), &quot;en&quot;);</span>
<span class="fc" id="L251">        response.setHeader(CACHE_CONTROL.getHeader(), &quot;no-cache&quot;);</span>
<span class="fc" id="L252">        response.setHeader(PRAGMA.getHeader(), &quot;no-cache&quot;);</span>
<span class="fc" id="L253">    }</span>

    @SuppressWarnings(&quot;PMD&quot;)
    private void setSuccessHeaders(HttpResponse response) {
<span class="fc" id="L257">        setDefaultHeaders(response);</span>
<span class="fc" id="L258">        String temp[] = split(request.getUrn(), &quot;.&quot;);</span>
<span class="fc" id="L259">        String extension = temp[temp.length - 1];</span>
<span class="fc" id="L260">        setContentType(response, DEFAULT.getMimeViaExtension(extension));</span>
<span class="fc" id="L261">        response.setHeader(CACHE_CONTROL.getHeader(), &quot;public, max-age=0&quot;);</span>
<span class="fc" id="L262">    }</span>

    private void setContentType(HttpResponse response, String mime) {
<span class="fc" id="L265">        response.setHeader(CONTENT_TYPE.getHeader(), mime + &quot;; charset=utf-8&quot;);</span>
<span class="fc" id="L266">    }</span>

    private void setDefaultHeaders(HttpResponse response) {
<span class="fc" id="L269">        DateFormat dateFormat = DateFormat.getTimeInstance();</span>
<span class="fc" id="L270">        dateFormat.setTimeZone(TimeZone.getTimeZone(&quot;GMT&quot;));</span>
<span class="fc" id="L271">        response.setHeader(DATE.getHeader(), dateFormat.format(new Date()));</span>
<span class="fc" id="L272">        response.setHeader(SERVER.getHeader(), &quot;ServerLite&quot;);</span>
<span class="fc" id="L273">        response.setHeader(CONNECTION.getHeader(), &quot;close&quot;);</span>
<span class="fc" id="L274">    }</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.6.201602180812</span></div></body></html>